<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>App de Imóveis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family:'Segoe UI',sans-serif;
      background:#f4f6f8;
      margin:0;
      padding:0;
    }

    #lista {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
      margin-bottom:30px;
    }

    .card {
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);
      overflow:hidden;
      background:#fff;
      transition: transform 0.2s, box-shadow 0.2s;
      display:flex;
      flex-direction:column;
    }

    /* WhatsApp flutuante fixo com ícone */
    #whatsapp-flutuante {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #25d366;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
      z-index: 1000;
    }

    #whatsapp-flutuante img {
      width: 35px;
      height: 35px;
    }

    #whatsapp-flutuante:hover {
      background: #1ebe5c;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      padding-top: 60px;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    .modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }

    .btn-whatsapp {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 15px;
      background: #25d366;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
    }

    .btn-whatsapp:hover {
      background: #1ebe5c;
    }

    /* Destaques */
    #destaques-container {
      position: relative;
      overflow: hidden;
      margin: 20px;
    }

    #destaques {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      scroll-behavior: smooth;
    }

    .destaque-card {
      flex: 0 0 auto;
      width: 200px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #fff;
      cursor: pointer;
      text-align: center;
      overflow: hidden;
    }

    .destaque-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 6px 10px;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .destaque-left { left: 5px; }
    .destaque-right { right: 5px; }
  </style>
</head>
<body>

<!-- Destaques -->
<div id="destaques-container">
  <span class="nav-arrow destaque-left">&#10094;</span>
  <div id="destaques"></div>
  <span class="nav-arrow destaque-right">&#10095;</span>
</div>

<div id="imoveis-app">
  <div id="tabs-container"></div>
  <div id="filtros-container"></div>
  <div id="ordenacao-container"></div>
  <div id="lista"></div>

  <div id="detalhesModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
</div>

<!-- Botão WhatsApp -->
<a id="whatsapp-flutuante" href="https://api.whatsapp.com/send?phone=5512992468636" target="_blank">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
</a>

<script>
/* ==================== Modal ==================== */
class ModalImovel {
  constructor(id) {
    this.modal=document.getElementById(id);
    this.body=this.modal.querySelector('#modal-body');
    this.close=this.modal.querySelector('.close');
    this.close.onclick=()=>{this.fechar();};
  }
  fechar(){this.modal.style.display='none';document.body.style.overflow='';}
  abrir(imovel){
    const imgs=imovel.imagens.split(' ').filter(i=>i);
    let idxImg=0;
    this.body.innerHTML=`<h2>${imovel.titulo}</h2>
      <p><b>Código:</b> ${imovel.ref||''}</p>
      <p><b>Preço:</b> R$ ${Number(imovel.preco).toLocaleString()} | <b>Cidade:</b> ${imovel.cidade}</p>
      <div style='position:relative;overflow:hidden;'>
        <img id='main-img' src='${imgs[0]||'https://via.placeholder.com/400x250'}'>
        <span class='nav-arrow nav-left'>&#10094;</span>
        <span class='nav-arrow nav-right'>&#10095;</span>
      </div>
      <div class='miniaturas'>${imgs.map((s,i)=>`<img src='${s}' class='${i===0?'selected':''}'>`).join('')}</div>
      <a class='btn-whatsapp' href='https://api.whatsapp.com/send?phone=5512992468636&text=Olá, interessei-me no imóvel ${imovel.titulo}' target='_blank'>WhatsApp</a>`;
    const main=this.body.querySelector('#main-img');
    const mini=this.body.querySelectorAll('.miniaturas img');
    const left=this.body.querySelector('.nav-left');
    const right=this.body.querySelector('.nav-right');
    const update=i=>{main.src=imgs[i];mini.forEach((m,j)=>m.classList.toggle('selected',i===j));idxImg=i;};
    mini.forEach((m,i)=>m.onclick=()=>update(i));
    left.onclick=()=>update((idxImg-1+imgs.length)%imgs.length);
    right.onclick=()=>update((idxImg+1)%imgs.length);
    this.modal.style.display='block';
  }
}

/* ==================== Lista ==================== */
class ListaImoveis {
  constructor(id,modal){this.lista=document.getElementById(id);this.modal=modal;this.filteredData=[];}
  render(dados,filtro={},tab=''){
    this.lista.innerHTML='';
    this.filteredData=dados.filter(i=>{
      const p=Number(i.preco);
      if(tab&&i.operacao!==tab) return false;
      if(filtro.busca&&!(`${i.titulo} ${i.descricao} ${i.bairro} ${i.ref||''}`.toLowerCase().includes(filtro.busca.toLowerCase()))) return false;
      if(filtro.cidade&&i.cidade!==filtro.cidade) return false;
      if(filtro.tipo&&i.tipo!==filtro.tipo) return false;
      if(filtro.pet&&i.pet!==filtro.pet) return false;
      if(filtro.condominio&&i.condominio!==filtro.condominio) return false;
      if(filtro.precoMin&&p<Number(filtro.precoMin)) return false;
      if(filtro.precoMax&&p>Number(filtro.precoMax)) return false;
      return true;
    });
    this.filteredData.forEach(i=>{
      const c=document.createElement('div');c.className='card';
      c.innerHTML=`<img src='${i.imagens.split(' ')[0]||'https://via.placeholder.com/400x250'}'>
        <div class='card-body'>
          <h3>${i.titulo}</h3>
          <p class='preco'>R$ ${Number(i.preco).toLocaleString()}</p>
          <p>${i.cidade} | ${i.tipo}</p>
          <button class='btn-detalhes'>Detalhes</button>
        </div>`;
      c.querySelector('.btn-detalhes').onclick=()=>this.modal.abrir(i);
      this.lista.appendChild(c);
    });
  }
}

/* ==================== Filtro ==================== */
class FiltroImoveis{
  constructor(id,dados,lista){
    this.c=document.getElementById(id); this.dados=dados; this.lista=lista;
    const cidades=[...new Set(dados.map(i=>i.cidade))];
    const tipos=[...new Set(dados.map(i=>i.tipo))];
    this.c.innerHTML=`<input id="busca" placeholder="Tít., desc., bairro ou código">
      <select id="filtroCidade"><option value="">Cidades</option>${cidades.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
      <select id="filtroTipo"><option value="">Tipos de Imóveis</option>${tipos.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
      <select id="filtroPet"><option value="">Aceita Pet?</option><option value="Sim">Sim</option><option value="Não">Não</option></select>
      <select id="filtroCondo"><option value="">Condomínio Incluso?</option><option value="Sim">Sim</option><option value="Não">Não</option></select>
      <input id="filtroPrecoMin" type="number" placeholder="Preço mínimo">
      <input id="filtroPrecoMax" type="number" placeholder="Preço máximo">`;
    const update=()=>{ 
      const f={
        busca:this.c.querySelector("#busca").value,
        cidade:this.c.querySelector("#filtroCidade").value,
        tipo:this.c.querySelector("#filtroTipo").value,
        pet:this.c.querySelector("#filtroPet").value,
        condominio:this.c.querySelector("#filtroCondo").value,
        precoMin:this.c.querySelector("#filtroPrecoMin").value,
        precoMax:this.c.querySelector("#filtroPrecoMax").value
      };
      const tab=document.querySelector(".tab.active")?.dataset.tab||"";
      this.lista.render(this.dados,f,tab);
    }
    ["busca","filtroCidade","filtroTipo","filtroPet","filtroCondo","filtroPrecoMin","filtroPrecoMax"].forEach(id=>{
      const el=this.c.querySelector("#"+id);
      el.tagName==="INPUT"?el.addEventListener("input",update):el.addEventListener("change",update);
    });
    update();
  }
}

/* ==================== Tabs ==================== */
class TabsImoveis {
  constructor(id, dados, lista) {
    this.c = document.getElementById(id);
    this.dados = dados;
    this.lista = lista;
    const tabs = [...new Set(dados.map(i => i.operacao))];
    tabs.unshift("Todos");
    this.c.innerHTML = "";
    tabs.forEach(tab => {
      const t = document.createElement("span");
      t.className = "tab";
      t.dataset.tab = (tab === "Todos" ? "" : tab);
      t.textContent = tab.charAt(0).toUpperCase() + tab.slice(1).toLowerCase();
      t.onclick = () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const f = {};
        this.lista.render(this.dados, f, t.dataset.tab);
      };
      this.c.appendChild(t);
    });
    this.c.querySelector(".tab").classList.add("active");
  }
}

/* ==================== Ordenacao ==================== */
class OrdenacaoImoveis{
  constructor(id,lista){
    this.c=document.getElementById(id); this.lista=lista;
    this.c.innerHTML=`<select class="ordenacao-select" id="ordenar"><option value="">Ordenar por</option>
      <option value="preco_asc">Preço Crescente</option>
      <option value="preco_desc">Preço Decrescente</option>
      <option value="area_asc">Área Crescente</option>
      <option value="area_desc">Área Decrescente</option></select>`;
    this.c.querySelector("#ordenar").addEventListener("change",e=>{
      const val=e.target.value;
      const data=this.lista.filteredData.slice();
      if(val==="preco_asc") data.sort((a,b)=>Number(a.preco)-Number(b.preco));
      if(val==="preco_desc") data.sort((a,b)=>Number(b.preco)-Number(a.preco));
      if(val==="area_asc") data.sort((a,b)=>Number(a.area)-Number(b.area));
      if(val==="area_desc") data.sort((a,b)=>Number(b.area)-Number(a.area));
      this.lista.render(data);
    });
  }
}

/* ==================== Destaques ==================== */
class Destaques{
  constructor(imoveis){
    this.i=imoveis;
    this.renderDestaques();
  }
  renderDestaques(){
    const container=document.getElementById("destaques");
    if(!container) return;
    const cardsHTML=this.i.slice(0,10).map(imovel=>`
      <div class="destaque-card">
        <img src="${imovel.imagens.split(" ")[0]||'https://via.placeholder.com/200x120'}">
        <p>${imovel.titulo} - R$ ${Number(imovel.preco).toLocaleString()}</p>
      </div>
    `).join('');
    container.innerHTML=cardsHTML+cardsHTML;
    const allCards=container.querySelectorAll(".destaque-card");
    const modal=new ModalImovel("detalhesModal");
    allCards.forEach((card,idx)=>{ card.onclick=()=>modal.abrir(this.i[idx%10]); });
    const cardWidth=container.querySelector(".destaque-card")?.offsetWidth+16||216;
    const left=document.querySelector(".destaque-left");
    const right=document.querySelector(".destaque-right");
    const scrollByCard=(amount)=>{ container.scrollBy({left:amount,behavior:'smooth'}); setTimeout(()=>{
      if(container.scrollLeft>=container.scrollWidth/2) container.scrollLeft-=container.scrollWidth/2;
      if(container.scrollLeft<=0) container.scrollLeft+=container.scrollWidth/2;
    },300)};
    if(left) left.onclick=()=>scrollByCard(-cardWidth);
    if(right) right.onclick=()=>scrollByCard(cardWidth);
    setInterval(()=>scrollByCard(cardWidth),4000);
    let startX=0;
    container.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
    container.addEventListener("touchmove",e=>{ const diff=startX-e.touches[0].clientX; if(Math.abs(diff)>30){ scrollByCard(diff>0?cardWidth:-cardWidth); startX=e.touches[0].clientX; }});
  }
}

/* ==================== CSV ==================== */
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";
Papa.parse(csvUrl, {
  download: true,
  header: false, // não usa a primeira linha como cabeçalho
  skipEmptyLines: true,
  complete: res => {
    // remove a primeira linha manualmente
    const dadosBrutos = res.data.slice(1);

    // agora você adapta os índices de cada coluna para montar seus imóveis
    const dados = dadosBrutos.map(linha => {
      return {
        ref: linha[0] || "",
        titulo: linha[1] || "",
        descricao: linha[2] || "",
        tipo: linha[3] || "",
        operacao: linha[4] || "",
        cidade: linha[5] || "",
        preco: linha[6] || "0",
        area: linha[7] || "0",
        banheiros: linha[8] || "0",
        quartos: linha[9] || "0",
        garagem: linha[10] || "0",
        pet: (linha[11] && ["sim","s","1"].includes(linha[11].trim().toLowerCase())) ? "Sim" : "Não",
        condominio: (linha[12] && ["sim","s","1"].includes(linha[12].trim().toLowerCase())) ? "Sim" : "Não",
        imagens: linha[13] || ""
      }
    });

    const modal=new ModalImovel("detalhesModal");
    const lista=new ListaImoveis("lista",modal);
    new FiltroImoveis("filtros-container",dados,lista);
    new TabsImoveis("tabs-container",dados,lista);
    new OrdenacaoImoveis("ordenacao-container",lista);
    new Destaques(dados);
  }
});
</script>
</body>
</html>
